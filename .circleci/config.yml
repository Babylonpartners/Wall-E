version: 2.1

- &quay_login
  run: docker login -u "${DOCKER_USER}" -p "${DOCKER_PASS}" quay.io

- &only_tagged
  filters:
    branches:
      ignore:
      - /^.*$/
    tags:
      only:
      - /^.*$/

jobs:
  test:
    docker:
      - image: swift:4.2
    steps:
      - checkout
      - run:
          name: Compile code
          command: swift build
      - run:
          name: Run unit tests
          command: swift test
    
  build:
    steps:
    - checkout
    - setup_remote_docker
    - *quay_login
    - run:
        name: Build image
        command: make build

  deploy:
    steps:
      - run:
          name: Deploy image
          command: make install


workflows:
  version: 2
  build-and-deploy:
    jobs:
      - test:
        context: babylon
      - build:
        context: babylon
        requires:
          - build
      - deploy:
        context: babylon
        <<: *only_tagged
        requires:
          - test
          - build
